<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Analytics Anyways</title>

    <link rel="stylesheet" href="index.css" type="text/css" />
    <link rel="stylesheet" href="leaflet/leaflet.css" type="text/css" />
    <link rel="stylesheet" href="leaflet-control-geocoder/Control.Geocoder.css" type="text/css" />

    <script src="leaflet/leaflet-src.js"></script>
    <script src="leaflet-control-geocoder/Control.Geocoder.js"></script>
    <script src="jquery/jquery-3.1.0.min.js"></script>

    <script src="app/ANYWAYS.base.js"></script>
    <script src="app/ANYWAYS.JSONP.js"></script>
    <script src="app/api/ANYWAYS.api.js"></script>

</head>
<body>
    <div id="map"></div>
	<script>
        var map = L.map('map').setView([51.05470154795641, 3.7240487337112427], 13);
        var marker = null;

        L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXVyb3N0YXRpb24iLCJhIjoickVCa3JCTSJ9.EdN8BIazD16z2PHyGShqtA', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18
        }).addTo(map);

        // add and create routing control.
        var geocodingcontrol = L.Control.geocoder({
                geocoder: L.Control.Geocoder.nominatim()
            });
        geocodingcontrol.markGeocode = function (result) {
            if (result.center) {
                map.panTo(result.center);
            }
        };
        geocodingcontrol.addTo(map);

        var max = 450;
        var requestId = 0;
        var layers = [];

        var gradient2 = function (color1, color2, ratio) {
            var hex = function (x) {
                x = x.toString(16);
                return (x.length == 1) ? '0' + x : x;
            };

            var r = Math.ceil(parseInt(color1.substring(0, 2), 16) * ratio + parseInt(color2.substring(0, 2), 16) * (1 - ratio));
            var g = Math.ceil(parseInt(color1.substring(2, 4), 16) * ratio + parseInt(color2.substring(2, 4), 16) * (1 - ratio));
            var b = Math.ceil(parseInt(color1.substring(4, 6), 16) * ratio + parseInt(color2.substring(4, 6), 16) * (1 - ratio));

            return hex(r) + hex(g) + hex(b);
        };

        var gradient = function (ratio) {
            if (ratio > 0.6)
            {
                return gradient2('FF0000', '00FF00', (ratio - 0.6) / 0.4);
            }
            return gradient2('00FF00', 'FFFFFF', (ratio / 0.6));
        };

        var requestRoute = function (loc) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(loc, {
                //draggable: true,
                icon: L.icon({
                    iconUrl: 'images/marker-source.png',
                    iconAnchor: [12, 35],
                    iconSize: [25, 35],
                    shadowUrl: 'images/marker-shadow.png'
                })
            }).addTo(map);

            ANYWAYS.api.tree('http://analytics-api.anyways.eu/belgium',
            {
                profile: 'car',
                locations: [{
                    lat: loc.lat,
                    lon: loc.lng
                }],
                max: max
            }, function (response, currentId, options) {
                requestId++;
                var localRequestId = requestId;

                for (var i = 0; i < layers.length; i++) {
                    map.removeLayer(layers[i]);
                }

                var idx = 0;
                var stepTime = 1500.0 / response.features.length;
                var animation = function () {
                var c = 4;
                while(c > 0) {		
                	if (idx < response.features.length) {
	                    if (requestId == localRequestId) {
	                        var feature = response.features[idx];
	                        if (feature.geometry.type === "LineString") {
	                            layers.push(L.geoJson(feature, {
	                                style: function (feature) {
	                                    if (feature.properties && feature.properties.start_weight) {
	                                        var ratio = feature.properties.start_weight / max;
	                                        var color = '#' + gradient(ratio);
	                                        var weight = 2 * (1 - ratio);
	                                        return {
	                                            weight: weight,
	                                            color: color,
	                                            opacity: 1
	                                        };
	                                    }
	                                }
	                            }).addTo(map));
	                        }
	                    }
                    	}
			c--;
	                idx++;
                    }
                    idx++;
                    if (idx < response.features.length) {
                        setTimeout(function () {
                            animation();
                        }, stepTime);
                    } else {
                    }
                };
                animation();

                //treeLayer = L.geoJson(response, {
                //    style: function(feature) {
                //        if (feature.properties && feature.properties.start_weight) {
                //            var ratio = feature.properties.start_weight / max;
                //            var color = '#' + gradient(ratio);
                //            var weight = 4 * (1 - ratio);
                //            return {
                //                weight: weight,
                //                color: color,
                //                opacity: 1
                //            };
                //        }
                //    }
                //}).addTo(map);
            }, function (response, currentId, options) {
                console.log('ERROR:' + response);
            }, this);
        };

        map.on('click', function (e) {
            var loc = e.latlng;

            requestRoute(loc);
        });

        var start = {
            lng: 3.7240487337112427,
            lat: 51.05470154795641
        };
        requestRoute(start);
	</script>
</body>
</html>
